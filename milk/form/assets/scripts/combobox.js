/** * @author xuld */using("Controls.Core.IDropDownMenuContainer");using("Controls.Form.CombinedTextBox");using("Controls.Form.ListBox");var ComboBox = CombinedTextBox.extend(IDropDownMenuContainer).implement({		xType: 'combobox',		onKeyDown: function(e){		switch(e.keyCode) {			case 40:			case 38:				this.showDropDownMenu();				this.dropDownMenu.selectNext(e.keyCode === 40);			    e.preventDefault();			    return;			case 13:			case 10:				var currentIndex = this.dropDownMenu.getSelectedIndex();				if(currentIndex != -1) {					this.onSelectItem(this.controls[currentIndex]);					e.preventDefault();				}		}	},		onDropDownMenuOpen: function(){				// 默认选中当前项。		this.updateDropDownMenu();		this.trigger('dropdownmenuopen');	},		onSelect: function(item){		return this.trigger('select', item);	},		onSelectItem: function (item) {		if(this.onSelect(item)) {			this.hideDropDownMenu();			this.setSelectedItem(item);		}		return false;			},		init: function (options) {				// 1. 初始化下拉菜单		// 创建下拉菜单		var listBox = new ListBox(), defaultSelectedItem;				// 绑定 mouseover 时改变当前的项。		listBox.bindSelector('mouseover');				// 设置下拉菜单		this.setDropDownMenu(listBox);				// 绑定下拉菜单的点击事件		listBox.on('itemclick', this.onSelectItem, this);				// 关联下拉菜单列表和当前列表。		this.items = this.controls = listBox.controls;				// 2. 处理 <select>				// 如果初始化的时候传入一个 <select> 则替换 <select>, 并拷贝相关数据。		if(this.dom.tagName === 'SELECT') {			var select = this.dom;						// 调用 create 重新生成 dom 。			this.dom = this.create(options);						// 替换 <select> 为新的 dom。			select.parentNode.replaceChild(this.dom, select);						// 让 listBox 拷贝 <select> 的成员。			listBox.copyItemsFromSelect(select);						// 设置文本框为只读的。			this.setDropDownList();						// 获取默认选中的项，方便在下文设置默认值。			defaultSelectedItem = listBox.getSelectedItem();					}				// 3. 初始化文本框				// 初始化文本框		this.base('init');				if(this.textBox.dom.name){			this.setName(this.textBox.dom.name);			this.textBox.dom.name = '';		}				// 4. 绑定事件				// 设置默认值。		if(defaultSelectedItem) {			listBox.clear();			this.onSelectItem(defaultSelectedItem);			}				// 设置点击下拉菜单时执行菜单显示。		this.menuButton.on('click', this.toggleDropDownMenu, this);				// 监听键盘事件。		this.on('keydown', this.onKeyDown);				// IE6 Hack: keydown 无法监听到回车。		if(navigator.isIE6) {			this.on('keypress', this.onKeyDown);			}	},		/**	 * 设置当前组合框是否允许用户输入自定义的值。	 */	setDropDownList: function (value) {		var textBox = this.find('.x-textbox');		if(textBox.dom.readOnly = value !== false){			textBox.addClass('x-combobox-dropdownlist').on('click', this.toggleDropDownMenu, this);			} else {			textBox.removeClass('x-combobox-dropdownlist').un('click', this.toggleDropDownMenu, this);		}		return this;	},		/**	 * 获取当前组合框的值。	 */	getValue: function(){		return this.dropDownMenu.getValue();	},		/**	 * 设置当前组合框的值。	 */	setValue: function(value){		var old = this.getValue();				this.dropDownMenu.setValue(value);				if(this.formProxy) {			this.formProxy.value = value;		}				var t = this.dropDownMenu.getSelectedItem();				// 如果选择的项，则表示 value 设置成功。		if(t) {			this.setText(t.getText());					// 否则， 找不到对应 value 的项。		} else if(old !== value){			this.onChange(old, value);		}		return this;	},		/**	 * 将当前文本的值同步到下拉菜单。	 */	updateDropDownMenu: function(){		return this.dropDownMenu.setText(this.getText());	},		setName: ListBox.prototype.setName,		getName: ListBox.prototype.getName,		setSelectedItem: function(value){		this.setValue(this.dropDownMenu.baseGetValue(value));	},		getSelectedItem: function(){		return this.updateDropDownMenu().getSelectedItem();	},		setSelectedIndex: function(value){		return this.setSelectedItem(this.items[value]);	},		getSelectedIndex: function(){		return this.updateDropDownMenu().getSelectedIndex();	}}).addEvents({select:{}});